---
title: "Example Simple-forecasts"
output:
  md_document:
    variant: gfm
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r, include=FALSE}

options(scipen=5)

library(simpleforecasts)
library(tidyverse)
library(series.4macro)
library(fable)
library(feasts)
library(tsibble)
library(seasonal)
library(tsibbledata)

```

## Utils

Funções que não realizam projeções, mas são úteis e fornecem suporte ao trabalho.

### load_clean_series

Carrega as séries do 4macro em formato _tibble_.  
As séries são retornadas empilhadas, organizadas pela coluna sid.  
Contém as colunas: sid, date, forecast, vl  


```{r}
data <- simpleforecasts::load_clean_series(
  sid_vl = c(
    'BRGDP0081000ROML', #PIB 4i
    'BRIND0001000OOML', #PIM
    'BRIND0002000OOML', #PIM Extrativa
    'BRIND0003000OOML', #PIM Transformação
    'BRPRC0046000OOML', #IPCA BR
    'USPRC0001000OOML', #IPC US
    'BRFXR0003000OAML', #Cambio R$/USD
    'BRFXR0031000OODL', #Cambio Diário
    'BRMTG0003JOIOAML'  #Temperatura Média
    ),
  auth_path = '../auth.ini',
  estimate = F
)
```

### split_series

Recupera apenas uma das séries carregadas pela fct _load_clean_series_.  
Também permite filtrar se é desejado dado estimado ou não.  

```{r}
pib_4i <- data %>% 
  simpleforecasts::split_series(sid_vl = 'BRGDP0081000ROML')
```


### get_seas_adj

Calcula, automaticamente, a série sem efeito sazonal.   
Utiliza o método X13, STL ou uma média entre eles.  

```{r}
pib_dessaz <- pib_4i %>% 
  get_seas_adj()
```

```{r, include=FALSE}
pib_fs_dessaz <- load_clean_series(
  sid_vl = 'BRGDP0081000WOML',
  estimate = FALSE,
  auth_path = '../auth.ini'
) %>% 
  split_series('BRGDP0081000WOML')
```


```{r, echo=FALSE}
plot_dessaz <- pib_4i %>% 
  rename(original = vl) %>% 
  left_join(pib_dessaz) %>% 
  rename(sf_dessaz = vl) %>% 
  left_join(pib_fs_dessaz) %>% 
  rename(fs_dessaz = vl) %>% 
  select(-forecast) %>% 
  pivot_longer(-date) %>% 
  filter(date >= '2010-01-01')

ggplot(plot_dessaz, aes(x=date, y=value, color=name)) +
  geom_line(size = 1)
```

### cambio_real

Calcula a taxa de câmbio real, utilizando a inflação dos dois países.
Deve-se selecionar um ano-mês para corresponder à base do índice.

```{r}
rs_usd <- data %>% 
  split_series('BRFXR0003000OAML') %>% 
  filter(date >= '1994-12-01')

ipca <- data %>% 
  split_series('BRPRC0046000OOML')

ipc_us <- data %>% 
  split_series('USPRC0001000OOML')
```

```{r}
rs_usd_real <- simpleforecasts::cambio_real(
  df = rs_usd,
  df_ipc_dom = ipca,
  df_ipc_int = ipc_us,
  mes_base = '1995-01-01'
) 
```
```{r, include=FALSE}
real_fs <- load_clean_series(
  sid_vl = 'BRFXR0005000RAML',
  estimate = F,
  auth_path = '../auth.ini'
) %>% 
  split_series('BRFXR0005000RAML') %>% 
  filter(date >= '1995-01-01')
```


```{r, echo=FALSE}
#Como o cambio da FS está em numero indice
#Converti o output do pkg para numero indice tbm
plot_cambio <- rs_usd %>% 
  rename(nominal = vl) %>% 
  left_join(rs_usd_real) %>% 
  rename(sf_real = vl) %>% 
  left_join(real_fs) %>% 
  rename(fs_real = vl) %>% 
  select(-forecast) %>% 
  na.omit() %>% 
  mutate(
    nominal = nominal / lag(nominal,1),
    sf_real = sf_real / lag(sf_real,1),
    across(where(is.numeric), ~ifelse(date == '1995-01-01', 100, .x)),
    nominal = cumprod(nominal),
    sf_real = cumprod(sf_real)
  ) %>% 
  pivot_longer(-date)


ggplot(plot_cambio, aes(x = date, y = value, color = name)) +
  geom_line(size = 1)
```

## Simples

Funções que realizam projeções simples, sem qualquer modelo de série de tempo. 
Elas devem funcionar tanto para periodicidade mensal quanto trimestral.

Existem três grupos:

1) Utiliza informação histórica da própria série:

a) sf_naive: repete último valor;
b) sf_snaive: repete último valor/média de X anos para um mesmo mês;
c) sf_drif: opção _hist_, utiliza tendência histórica de X anos;

2) Utiliza uma informação inserida manualmente: 

O dado passado como parâmetro pode provir de uma projeção feita em periodicidade maior (de anual para mensal; de mensal para diária). Ou então provir de uma premissa (0.1% de crescimento mensal; YoY de 5%)

a) sf_drift: opções _manual_ e _target_, adicionam tendência com base em crescimento mensal esperado ou em um alvo para o último mês;
b) sf_target: equivalente ao sf_drift opção _target_, com a diferença que adiciona sazonalidade, por meio do fator sazonal médio histórico;
c) sf_aop: projeta utilizando YoY médio para o ano. Compatibiliza o YoY para o restante do primeiro para respeitar a média desejada.

3) Utiliza projeção calculada em outra série:

a) sf_daily: projeta a série diária como sendo interpolação linear até o dado para o mês, vindo de outra série;
b) sf_topdown: utiliza a mesma variação anual que outra série;
c) sf_seas_ratio: projeta a série original a partir de sua projeção dessaz;
d) sf_conversao_cambio: projeta um par de câmbio a partir de outros dois.

### sf_naive

```{r}
pib_naive <- pib_4i %>% 
  simpleforecasts::sf_naive(end_forecast = '2025-12-01')
```

```{r, include=FALSE}
ggplot(pib_naive,
       aes(x = date, y = vl)) +
  geom_line(size = 1) +
  annotate("rect",
         xmin = max(filter(pib_naive,!forecast)$date),
         xmax = max(pib_naive$date),
         ymin = min(filter(pib_naive,!forecast)$vl),
         ymax = Inf,
         alpha = 0.2)
```
### sf_snaive

Segue a mesma ideia do _sf_naive_, no entanto, ao invés de repetir o último valor, repete o valor médio do histórico para o mesmo mês. 

o parâmetro _nyears_, permite selecionar X anos do histórico para calcular a média dos valores para o mês. Se vazio, utiliza a média do histórico.

```{r}
pib_snaive <- pib_4i %>% 
  simpleforecasts::sf_snaive(end_forecast = '2025-12-01')
```

```{r, echo=FALSE}
ggplot(pib_snaive,
       aes(x = date, y = vl)) +
  geom_line(size = 1) +
  annotate("rect",
         xmin = max(filter(pib_snaive,!forecast)$date),
         xmax = max(pib_snaive$date),
         ymin = min(filter(pib_snaive,!forecast)$vl),
         ymax = Inf,
         alpha = 0.2)
```

```{r}
pib_snaive_3y <- pib_4i %>% 
  simpleforecasts::sf_snaive(nyear = 3, end_forecast = '2025-12-01')
```

```{r, echo=FALSE}
ggplot(pib_snaive_3y,
       aes(x = date, y = vl)) +
  geom_line(size = 1) +
  annotate("rect",
         xmin = max(filter(pib_snaive_3y,!forecast)$date),
         xmax = max(pib_snaive_3y$date),
         ymin = min(filter(pib_snaive_3y,!forecast)$vl),
         ymax = Inf,
         alpha = 0.2)
```
